services:
  rustfs:
    image: rustfs/rustfs:1.0.0-alpha.83
    restart: unless-stopped
    environment:
      RUSTFS_VOLUMES: /data
      RUSTFS_ADDRESS: '0.0.0.0:9000'
      RUSTFS_CONSOLE_ADDRESS: '0.0.0.0:9001'
      RUSTFS_CONSOLE_ENABLE: 'true'
      RUSTFS_ACCESS_KEY: rustfsuser
      RUSTFS_SECRET_KEY: rustfspassword
    ports:
      - '8999:9000' # 9000 is taken by clickhouse, map to 8999
      - '9001:9001' # web console
    volumes:
      - rustfs:/data
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 5s
      timeout: 5s
      retries: 5
  rustfs-init:
    image: minio/mc:RELEASE.2025-08-13T08-35-41Z
    restart: on-failure  # run once and exit
    entrypoint: >
      /bin/sh -c "
      sleep 2;
      until mc alias set local http://rustfs:9000 $$RUSTFS_ACCESS_KEY $$RUSTFS_SECRET_KEY; do echo waiting for rustfs...; sleep 1; done;
      mc mb --ignore-existing local/bucket1;
      exit 0;
      "
    environment:
      RUSTFS_ACCESS_KEY: rustfsuser
      RUSTFS_SECRET_KEY: rustfspassword
    depends_on:
      rustfs:
        condition: service_healthy
  ice-rest-catalog:
    image: altinity/ice-rest-catalog:0.12.0
    restart: unless-stopped
    ports:
      - '5001:5000'
    configs:
      - source: ice-rest-catalog-yaml
        target: /etc/ice/ice-rest-catalog.yaml
    volumes:
      - ice-rest-catalog-data:/var/lib/ice-rest-catalog
    depends_on:
      - rustfs-init
  clickhouse:
    image: altinity/clickhouse-server:25.8.12.20747.altinityantalya-alpine
    restart: unless-stopped
    environment:
      CLICKHOUSE_SKIP_USER_SETUP: "1" # insecure
    ports:
      - "8123:8123" # clickhouse/http
      - "9000:9000" # clickhouse/native
    configs:
      - source: clickhouse-init
        target: /docker-entrypoint-initdb.d/init-db.sh
    volumes:
      - ./data/docker-compose/clickhouse/var/log/clickhouse-server:/var/log/clickhouse-server
    depends_on:
      - ice-rest-catalog
  ice:
    image: altinity/ice:${ICE_TAG:-0.12.0}
    pull_policy: ${ICE_PULL_POLICY:-always}
    configs:
      - source: ice-yaml
        target: /app/.ice.yaml
    working_dir: /app
    depends_on:
      - ice-rest-catalog
    profiles:
      - tools
  otlp2parquet:
    image: ghcr.io/smithclay/otlp2parquet:0.9.0
    restart: unless-stopped
    environment:
      OTLP2PARQUET_STORAGE_BACKEND: s3
      OTLP2PARQUET_S3_BUCKET: bucket1
      OTLP2PARQUET_S3_ENDPOINT: http://rustfs:9000
      OTLP2PARQUET_S3_REGION: us-east-1
      AWS_ACCESS_KEY_ID: rustfsuser
      AWS_SECRET_ACCESS_KEY: rustfspassword
      # Batching settings
      OTLP2PARQUET_BATCHING_ENABLED: "true"
      OTLP2PARQUET_BATCH_MAX_ROWS: 200000
      OTLP2PARQUET_BATCH_MAX_AGE_SECS: 30
    depends_on:
      - rustfs-init
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.123.0
    restart: unless-stopped
    ports:
      - '4318:4318' # OTLP/HTTP
    configs:
      - source: otel-collector-yaml
        target: /etc/otelcol-contrib/config.yaml
    depends_on:
      - otlp2parquet
  otelgen:
    image: ghcr.io/open-telemetry/opentelemetry-collector-contrib/telemetrygen:v0.123.0
    restart: unless-stopped
    command:
      - logs
      - --otlp-http
      - --otlp-endpoint=otel-collector:4318
      - --otlp-insecure
      - --logs=100000000
      - --rate=1000
      - --workers=10
    depends_on:
      - otel-collector
  log-sync:
    build: ./scripts
    restart: unless-stopped
    environment:
      RUSTFS_ENDPOINT: http://rustfs:9000
      RUSTFS_BUCKET: bucket1
      RUSTFS_ACCESS_KEY: rustfsuser
      RUSTFS_SECRET_KEY: rustfspassword
      ICE_CATALOG_URI: http://ice-rest-catalog:5000
      TABLE_NAME: otel.logs
      SYNC_INTERVAL: ${LOG_SYNC_INTERVAL:-60}
    configs:
      - source: ice-yaml
        target: /app/.ice.yaml
    depends_on:
      - ice-rest-catalog
      - otlp2parquet
  grafana:
    image: grafana/grafana:11.4.0
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      GF_INSTALL_PLUGINS: vertamedia-clickhouse-datasource
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - grafana-data:/var/lib/grafana
    depends_on:
      - clickhouse
configs:
  clickhouse-init:
    content: |
      #!/bin/bash
      exec clickhouse client --query $"
       SET allow_experimental_database_iceberg = 1;

        DROP DATABASE IF EXISTS ice;

        CREATE DATABASE ice
          ENGINE = DataLakeCatalog('http://ice-rest-catalog:5000')
          SETTINGS catalog_type = 'rest',
            storage_endpoint = 'http://rustfs:9000',
            warehouse = 's3://bucket1';
      "

  ice-rest-catalog-yaml:
    content: |
      uri: jdbc:sqlite:file:/var/lib/ice-rest-catalog/db.sqlite?journal_mode=WAL&synchronous=OFF&journal_size_limit=500
      warehouse: s3://bucket1
      s3:
        endpoint: http://rustfs:9000
        pathStyleAccess: true
        accessKeyID: rustfsuser
        secretAccessKey: rustfspassword
        region: us-east-1
      anonymousAccess:
        enabled: true
        accessConfig:
          readOnly: false
  ice-yaml:
    content: |
      uri: http://ice-rest-catalog:5000
      s3:
        endpoint: http://rustfs:9000
        pathStyleAccess: true
        accessKeyID: rustfsuser
        secretAccessKey: rustfspassword
        region: us-east-1
  otel-collector-yaml:
    content: |
      receivers:
        otlp:
          protocols:
            http:
              endpoint: 0.0.0.0:4318
      processors:
        batch:
          send_batch_size: 10000
          timeout: 5s
      exporters:
        otlphttp:
          endpoint: http://otlp2parquet:4318
          tls:
            insecure: true
      service:
        pipelines:
          logs:
            receivers: [otlp]
            processors: [batch]
            exporters: [otlphttp]
volumes:
  rustfs:
  ice-rest-catalog-data:
  grafana-data:
